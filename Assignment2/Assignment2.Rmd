---
title: "Assignment 2"
author: "Abdelmalek Hajjam"
date: "9/7/2019"
output:
  html_document: default
  pdf_document: default
---

In this assignment, I'm using a local instance of MySQL.
I created a schema (Database) called **movie-rating**.
The accompanying file called **movie-rating.sql** will create the tables and populate them with data.

**My tables are:**

1. movies table

2. reviewers table

3. Surveys_movie_rating table


I'm normalizing my tables to make them very flexible, like so:

---------------------------------------

CREATE TABLE movies (
  movie_id int(6) NOT NULL AUTO_INCREMENT,
  movie_title varchar(50)  NOT NULL,
  PRIMARY KEY (movie_id)
  );

CREATE TABLE reviewers (
reviewer_id int(6) NOT NULL AUTO_INCREMENT , 
reviewer_name char(50),
PRIMARY KEY (reviewer_id)  
  );

CREATE TABLE Surveys_Movie_Rating (
survey_id int(6) NOT NULL AUTO_INCREMENT,
reviewer_id int(6),
movie_id int(6),
Rating int(2),
PRIMARY KEY (survey_id)
);

--------------------------------------

In the Surveys_Movie_Rating table, the **Rating** field is a numeric field with values from 1 to 5. 1 being poor and 5 being excellent.



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

**Let's load the RMySQL and DBI packages after installing them **
```{r}
#install.packages("RMySQL")
library(RMySQL)
#let's also load DBI; normally the system will load it automatically for us. loading it manually after that will not hurt.
library(DBI)
```

**let's connect to the database using MySQL driver and return the tables in the database to make sure everything is solid**
```{r}

mydb <- dbConnect(MySQL(), user='root', password='theoracley', dbname='movie_rating', host='localhost')

#list of tables in the schema 'movie_rating'
tablesList <- dbListTables(mydb)
tablesList
```

**Let's read each table data**

```{r}
#get data from the movies table
moviesData <- dbGetQuery(mydb, 'select * from movies;')
moviesData
```

```{r}
#get data from the reviewers table
reviewersData <- dbGetQuery(mydb, 'select * from reviewers;')
reviewersData
```

```{r}
#get data from the surveys_movie_rating table
surveysData <- dbGetQuery(mydb, 'select * from surveys_movie_rating;')
surveysData
```

**While the data returned from surveys is for storage, a user cannot really read it and make sense of it, we need to return data that is very readable for users. Let's do it by combining the other tables with the main table **
```{r}
#return surveys data in a format that can be easily readable
data <- dbGetQuery(mydb, 'SELECT s.survey_id, r.reviewer_name, m.movie_title, s.Rating FROM Surveys_Movie_Rating s, movies m, reviewers r WHERE  (s.reviewer_id = r.reviewer_id AND s.movie_id = m.movie_id)')

data
```

**Let's see which movie got the highest Rating**
```{r}
#return the best movie on the top of the list with it's average
theBest <- dbGetQuery(mydb, 'select s.movie_id, m.movie_title, avg(Rating) as AVG_Rating
from Surveys_Movie_Rating s, movies m where s.movie_id = m.movie_id
group by movie_id
order by avg(Rating) desc;')

theBest
```
**It looks like the movie 'Casablanca' is the winner with an average rating of 4.6.**


#### Let's do some ditribution ploting
```{r}
#let's see the ditribution for Rating
table(data$Rating)

#Let's plot the Rating ditribution
barplot(table(data$Rating),xlab='Rating', ylab='Frequency', main='Barplot of Rating distribution', col='lightblue')
```
We see that Rating 1 was given only 1 time, Rating 2 was given 7 times, Rating 3 was given 8 times, Rating 4 was given 8 times too, and finally Rating 5 was given 6 times.



**Finally, let's close the connection and release resources**
```{r}
dbDisconnect(mydb)
```



